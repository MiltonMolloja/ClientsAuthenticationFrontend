<app-dashboard-layout>
  <div class="change-password-container">
    <div class="page-header">
      <h1>Change Password</h1>
      <p>Update your password to keep your account secure</p>
    </div>

    <mat-card class="change-password-card">
      <mat-card-header>
        <mat-card-title class="card-title-with-icon">
          <mat-icon>key</mat-icon>
          Update Password
        </mat-card-title>
        <mat-card-subtitle>
          Choose a strong password and don't reuse it for other accounts
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <form [formGroup]="changePasswordForm" (ngSubmit)="onSubmit()">
          <!-- Current Password Field -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Current Password</mat-label>
            <input
              matInput
              [type]="hideCurrentPassword ? 'password' : 'text'"
              formControlName="currentPassword"
              placeholder="Enter current password"
              required
            />
            <button
              mat-icon-button
              matSuffix
              type="button"
              (click)="togglePasswordVisibility('current')"
              [attr.aria-label]="'Hide current password'"
              [attr.aria-pressed]="!hideCurrentPassword"
            >
              <mat-icon>{{ hideCurrentPassword ? 'visibility' : 'visibility_off' }}</mat-icon>
            </button>
            @if (
              changePasswordForm.get('currentPassword')?.hasError('required') &&
              changePasswordForm.get('currentPassword')?.touched
            ) {
              <mat-error>Current password is required</mat-error>
            }
          </mat-form-field>

          <!-- New Password Field -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>New Password</mat-label>
            <input
              matInput
              [type]="hideNewPassword ? 'password' : 'text'"
              formControlName="newPassword"
              placeholder="Enter new password"
              required
            />
            <button
              mat-icon-button
              matSuffix
              type="button"
              (click)="togglePasswordVisibility('new')"
              [attr.aria-label]="'Hide new password'"
              [attr.aria-pressed]="!hideNewPassword"
            >
              <mat-icon>{{ hideNewPassword ? 'visibility' : 'visibility_off' }}</mat-icon>
            </button>
            @if (
              changePasswordForm.get('newPassword')?.hasError('required') &&
              changePasswordForm.get('newPassword')?.touched
            ) {
              <mat-error>New password is required</mat-error>
            }
            @if (
              changePasswordForm.get('newPassword')?.hasError('minlength') &&
              changePasswordForm.get('newPassword')?.touched
            ) {
              <mat-error>Password must be at least 8 characters</mat-error>
            }
            @if (
              changePasswordForm.get('newPassword')?.hasError('passwordSame') &&
              changePasswordForm.get('newPassword')?.touched
            ) {
              <mat-error>New password must be different from current password</mat-error>
            }
          </mat-form-field>

          <!-- Password Strength Indicator -->
          @if (changePasswordForm.get('newPassword')?.value) {
            <div class="password-strength">
              <div class="strength-bar-container">
                <div
                  class="strength-bar"
                  [style.width.%]="getPasswordStrength().strength"
                  [style.background-color]="getPasswordStrength().color"
                ></div>
              </div>
              <p class="strength-label" [style.color]="getPasswordStrength().color">
                {{ getPasswordStrength().label }}
              </p>
            </div>
          }

          <!-- Confirm Password Field -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Confirm New Password</mat-label>
            <input
              matInput
              [type]="hideConfirmPassword ? 'password' : 'text'"
              formControlName="confirmPassword"
              placeholder="Confirm new password"
              required
            />
            <button
              mat-icon-button
              matSuffix
              type="button"
              (click)="togglePasswordVisibility('confirm')"
              [attr.aria-label]="'Hide confirm password'"
              [attr.aria-pressed]="!hideConfirmPassword"
            >
              <mat-icon>{{ hideConfirmPassword ? 'visibility' : 'visibility_off' }}</mat-icon>
            </button>
            @if (
              changePasswordForm.get('confirmPassword')?.hasError('required') &&
              changePasswordForm.get('confirmPassword')?.touched
            ) {
              <mat-error>Please confirm your new password</mat-error>
            }
            @if (
              changePasswordForm.get('confirmPassword')?.hasError('passwordMismatch') &&
              changePasswordForm.get('confirmPassword')?.touched
            ) {
              <mat-error>Passwords do not match</mat-error>
            }
          </mat-form-field>

          <!-- Action Buttons -->
          <div class="form-actions">
            <button mat-stroked-button type="button" (click)="onCancel()" class="cancel-button">
              Cancel
            </button>
            <button
              mat-raised-button
              type="submit"
              class="submit-button amazon-button"
              [disabled]="changePasswordForm.invalid || isLoading"
            >
              @if (isLoading) {
                <mat-spinner diameter="20" class="button-spinner"></mat-spinner>
                <span>Updating...</span>
              } @else {
                <span>Update Password</span>
              }
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  </div>
</app-dashboard-layout>
